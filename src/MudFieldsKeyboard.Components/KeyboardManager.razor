@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(false))
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<VirtualKeyboard IsVisible="@_isVisible"
                 CurrentLayout="@_currentLayout"
                 AllowNegative="true"
                 AllowDecimal="@_allowDecimal"
                 OnKeyPressed="HandleKeyPressed"
                 OnBackspacePressed="HandleBackspacePressed"
                 OnClearPressed="HandleClearPressed"
                 OnClosePressed="HandleClosePressed" />

@code {
    private bool _isVisible;
    private KeyboardLayout _currentLayout;
    private bool _allowDecimal;
    private DotNetObjectReference<KeyboardManager>? _dotNetHelper;
    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_initialized)
        {
            _initialized = true;
            
            try
            {
                // Initialize the service with JSRuntime
                KeyboardService.Instance.Initialize(JSRuntime);
                
                // Create a reference to this component that can be called from JavaScript
                _dotNetHelper = DotNetObjectReference.Create(this);
                
                // Register with the global keyboard state manager
                await JSRuntime.InvokeVoidAsync("keyboardState.register", _dotNetHelper);
                
                // Initialize state from service
                _isVisible = KeyboardService.Instance.IsVisible;
                _currentLayout = KeyboardService.Instance.CurrentLayout;
                _allowDecimal = KeyboardService.Instance.AllowDecimal;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Log error for debugging
                Console.WriteLine($"KeyboardManager initialization error: {ex.Message}");
                _initialized = false; // Retry next render
            }
        }
    }

    [JSInvokable]
    public void OnKeyboardStateChanged(bool isVisible, int layout, bool allowDecimal)
    {
        _isVisible = isVisible;
        _currentLayout = (KeyboardLayout)layout;
        _allowDecimal = allowDecimal;
        StateHasChanged();
    }

    private void HandleKeyPressed(char key)
    {
        KeyboardService.Instance.HandleKeyPress(key);
    }

    private void HandleBackspacePressed()
    {
        KeyboardService.Instance.HandleBackspace();
    }

    private void HandleClearPressed()
    {
        KeyboardService.Instance.HandleClear();
    }

    private void HandleClosePressed()
    {
        KeyboardService.Instance.HideKeyboard();
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetHelper != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("keyboardState.dispose");
            }
            catch
            {
                // Ignore disposal errors
            }
            
            _dotNetHelper?.Dispose();
        }
    }
}
